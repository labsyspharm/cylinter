---
layout: default
title: metaQC
nav_order: 8
parent: Modules
---

8\. `metaQC` (optional): The metaQC module is designed to correct for QC status mis-classification that may have occurred due to inaccuracies in gating and cutoff selection. The module combines equal-sized batches of clean and noisy data and performs unsupervised, density-based clustering on them via [HDBSCAN](https://hdbscan.readthedocs.io/en/latest/api.html). Users are then presented with an interactive plot showing either a tSNE or UMAP embedding which is colored by HDBSCAN cluster at left, QC status and reclassification status at the center, and sample at right. A text box is provided to allow users to change the minimum cluster size (`min_cluster_size`, formatted as an integer value), which automatically re-renders the HDBSCAN plot with the updated cluster labels. To aid in identifying stable clustering solutions, a range of `min_cluster_size` values can be passed into the provided text boxes which will cause the program to loop over each value in ascending order and print the number of clusters associated with each value to the terminal window. Cells in the HDBSCAN plot may be interactively lassoed by clicking and holding the mouse button followed by closing the interactive plot window. Selected cells will come up in a Napari window which are colored by the stage at which they were filtered from the analysis from the specified tissue. Using the clean and noisy reclassification cutoff selectors, users specify tolerance limits on the proportion of clusters composed of clean and noisy data for cells identified clusters; ambiguous (or unclustered) cells maintain their original QC status annotations. Clicking the "save" button causes the program to reclassify data according to the current clustering solution and set of reclassification cutoffs. This module can be bypassed by toggling the `metaQC` parameter in `config.yml` to `False`. Regardless of this setting, a pie chart showing the fraction of data redacted by each of the prior QC filters is saved to `<output_dir/metaQC/censored_by_stage.pdf>`

### YAML configurations

| Parameter | Default | Description |
| --- | --- | --- |
| `metaQC` | True (bool) | If True, perform data reclassification based on clustering results of clean and noisy data and compute fraction of data redacted by prior QC modules. If False, do not perform data reclassification and compute fraction of data redacted by prior QC modules. |
| `embeddingAlgorithmQC` | UMAP (str) | Embedding algorithm to use for clustering (options: TSNE or UMAP) |
| `channelExclusionsClusteringQC` | [ ] (list) | Immunomarkers to exclude from clustering and all subsequent modules (strs) |
| `samplesToRemoveClusteringQC` | [ ] (list) | Samples to exclude from clustering and all subsequent modules (strs). |
| `fracForEmbeddingQC` | 1.0 (float) | Fraction of cells to be embedded (range: 0.0-1.0) limits the amount of data passed to downstream modules |
| `dimensionEmbeddingQC` | 2 (int) | Dimension of the embedding (int, typically 2) |
| `metricQC` | euclidean (str) | Distance metric for computing embedding. Choose from valid metrics used by scipy.spatial.distance.pdist: ‘braycurtis’, ‘canberra’, ‘chebyshev’, ‘cityblock’, ‘correlation’, ‘cosine’, ‘dice’, ‘euclidean’, ‘hamming’, ‘jaccard’, ‘jensenshannon’, ‘kulsinski’, ‘mahalanobis’, ‘matching’, ‘minkowski’, ‘rogerstanimoto’, ‘russellrao’, ‘seuclidean’, ‘sokalmichener’, ‘sokalsneath’, ‘sqeuclidean’, ‘yule’. |
| `perplexityQC` | 50.0 (float) | This is a tSNE-specific configuration (https://scikit-learn.org/stable/modules/generated/sklearn.manifold.TSNE.htmlRelated) related to the number of nearest neighbors used in other manifold learning algorithms. Larger datasets usually require larger perplexity. Different values can result in significantly different results. |
| `earlyExaggerationQC` | 12.0 (float) | This is a tSNE-specific configuration (https://scikit-learn.org/stable/modules/generated/sklearn.manifold.TSNE.htmlRelated). For larger values, the space between natural clusters will be larger in the embedded space. |
| `learningRateTSNEQC` | 200.0 (float) | This is a tSNE-specific configuration (https://scikit-learn.org/stable/modules/generated/sklearn.manifold.TSNE.htmlRelated). tSNE learning rate (float, typically between 10.0 and 1000.0) |
| `randomStateQC` | 5 (int) | This is a tSNE-specific configuration (https://scikit-learn.org/stable/modules/generated/sklearn.manifold.TSNE.htmlRelated). It determines the random number generator for reproducible results across multiple function calls. |
| `nNeighborsQC` | 5 (int) | This is a UMAP-specific configuration (https://umap-learn.readthedocs.io/en/latest/api.html). It determines the size of local neighborhood (in terms of number of neighboring sample points) used for manifold approximation. Larger values result in more global views of the manifold, while smaller values result in more local data being preserved. In general values should be in the range 2 to 100. |
| `learningRateUMAPQC` | 1.0 (float) | This is a UMAP-specific configuration (https://umap-learn.readthedocs.io/en/latest/api.html). It Determines the initial learning rate for the embedding optimization (float). |
| `minDistQC` | 0.1 (float) | This is a UMAP-specific configuration (https://umap-learn.readthedocs.io/en/latest/api.html). Determines the effective minimum distance between embedded points. Smaller values will result in a more clustered/clumped embedding where nearby points on the manifold are drawn closer together, while larger values will result on a more even dispersal of points. The value should be set relative to the spread value, which determines the scale at which embedded points will be spread out (float). |
| `repulsionStrengthQC` | 5.0 (float) | This is a UMAP-specific configuration (https://umap-learn.readthedocs.io/en/latest/api.html). Determines the weighting applied to negative samples in low dimensional embedding optimization. Values higher than one will result in greater weight being given to negative samples. |

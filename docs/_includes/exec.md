# Program execution

Begin by populating the template YAML configuration file (`config.yml`) with experimental metadata. Module-specific configurations may also be assigned. Activate the CyLinter virtual environment and run the program with the following commands:  

``` bash

source ~/cylinter/bin/activate

# Pass the previously configured YAML configuration file to CyLinter to run the program.
cylinter --module (optional) <cylinter_input_dir>/config.yml
```

* CyLinter begins by concatenating single-cell data from all feature tables into a single Pandas dataframe which is accomplished by the `getSingleCellData` module. To start the program from a different in the QC pipeline, specify the name of a desired module: `--module <module_name>`. This feature of CyLinter allows users to pick up where they left off and both within and among modules.

# User guide
CyLinter presents users with a series of graphical-user-interface (GUI) windows for image inspection, parameter selection, and data visualization in the identification and removal of cell segmentation instances corrupted by microscopy artifacts. Single-cell data are passed through the following series of QC modules (in order):

1. `getSingleCellData`: Combines single-cell data from whole tissue sections or individual TMA cores into a single dataframe. This module is fully automated.

2. `selectROIs`: ROIs are selected via positive or negative selection by toggling the `delint_mode` parameter in `<cylinter_input_dir>/config.yml`. Using polygon selection tools in the upper-left of the Napari image viewer (triangle and square icons), users draw boundaries around cells that wish to carry forward (positive selection) or drop (negative selection) from the analysis. Closing the Napari viewer window causes the module to advance to the next tissue sample until ROIs have been curated for all tissue samples in the analysis. Closing the Napari viewer without drawing ROIs causes the program to carry forward all cells for that tissue by default. Polygon vertices which define the coordinates of each polygon are stored as key:value pairs in `<cylinter_output_dir>/ROIs`. Removal of `<cylinter_output_dir>/ROI/polygon_dict.pkl` (or deletion of specific key:value pairs) is required to re-assign ROIs.

3. `dnaIntensityCutoff`: This module uses an interactive widget showing a histogram of mean nuclear counterstain intensity with sliders for assigning upper and lower cutoffs. Lower cutoffs aid in removing dim and out-of-focus cells, while upper cutoffs help in removing cells whose nuclei are oversaturated with DNA counterstain which often leads to nuclear mis-segmentation and can be caused by tissue bunching. Cells between upper and lower bounds can be visualized for a particular tissue by entering its name in the text box at the bottom of the widget. A Napari image viewer will then appear showing the nuclear counterstain from cycle 1 with scatter points colored by mean counterstain intensity and superimposed on the corresponding nuclear centroids of selected cells. Closing all Napari windows or closing the widget causes current thresholds to be applied and the program to proceed to the next module.

4. `dnaAreaCutoff`: Like `dnaIntensityCutoff`, this module also uses an interactive widget, but shows a histogram of mean nuclear area instead of mean counterstain intensity. Lower cutoffs help remove over-segmented nuclei; upper cutoffs aid in removing under-segmented cells.

5. `crossCycleCorrelation`: MCMICRO performs nuclear segmentation on images of tissues after the first application of nuclear counterstain (Hoechst, DAPI). Thus, cells that move or become detached from the microscope slide over the course of a multi-cycle experiment appear immuno-negative for all subsequent markers probed for after the drop-out event occurred. This module allows users to visualize correlation in mean nuclear signal intensity of individual cells across imaging cycles as histograms (log<sub>10</sub>(cycle<sub>1</sub>/cycle<sub>n</sub>). Either a single threshold on histogram counts (y-axis thresholding) can be applied to all tissues, or multiple thresholds can be applied on histogram bins (x-axis thresholding) (see `<cylinter_input_dir>/config.yml` for configuration details). Y-axis thresholding works well for experiments with relatively little tissue loss and streamlines the process, as a single cutoff is applied to a tissue. In this mode, users enter the counts cutoff and the name of a tissue of interest separated by a comma. The histogram plots will be re-computed, this time with a black horizontal line at the selected count cutoff for confirmation or refinement. This mode also causes a Napari window to open showing nuclear counterstain from all cycles and scatter points of nuclear centroids colorized by their log<sub>10</sub>(cycle<sub>n</sub>/cycle<sub>n+1</sub>) ratio. Cells whose signal intensity is higher in cycle<sub>n</sub> will be increasingly pink; cells whose signal intensity is higher in cycle<sub>n+1</sub> will be increasingly green. This step is currently for data exploration only and does not filter the single-cell data. X-axis thresholding is preferred for images exhibiting substantial tissue loss, as application of a single histogram counts cutoff will lead to inclusion of uncorrelated data points. Users have more control with this method, as upper and lower cutoffs are applied to histograms on a per cycle and per tissue basis using a method that is operationally similar to what is performed in the `dnaIntensityCutoff` module.

6. `log10transform`: Log-transform channel data. This module is fully automated and may become configurable in future releases.

7. `pruneOutliers`: This module allows users to assign upper and lower percentile cutoffs on immunomarker signal intensities in the removal of outliers that can significantly influence the range of natural protein distributions. Immunomarker signal intensities plotted either as scatter plots (immunomarker signal vs. nuclear area) or hexbin plots which reduces rendering time of large datasets (see `<cylinter_input_dir>/config.yml`). Users select cutoffs by entering lower and upper percentile cutoffs (range: 0.0-100.0) into the provided text box window. Pruned plots will then be rendered for confirmation or refinement. Once an optimal set of cutoffs has been defined for a particular channel, closing the text box window will cause the current cutoff settings to be saved and the program to proceed to the next channel. Closing the text box without entering cutoffs will rescale the signal intensities without outlier pruning. Cutoff values are stored as a Python dictionary of key:value pairs in `<cylinter_output_dir>/pruning/pruning_dict.pkl`. Once cutoffs for all channels have been made, the program will loop through the cutoff dictionary and drop cells from the dataframe in the same order in which they were curated. Removal of this file is required to re-assign percentile cutoffs. Deleting specific key:value pairs is not recommended, as percentile cutoffs are applied in a non-commutative ordered series.

8. `PCA`: Perform PCA using tissue sample mean immunomarker signal intensities. This module is automated and configurable; see `<cylinter_input_dir>/config.yml` for parameters and their descriptions.

9. `clustering`: This module performs hierarchical, density-based clustering (HDBSCAN) on either tSNE or UMAP embeddings of single-cell data from all samples in the analysis. See `<cylinter_input_dir>/config.yml` for configuration parameters and their descriptions. After embedding is complete, users are presented with a text box for entering a `min_cluster_size` for HDBSCAN clustering. This parameter has a significant effect on the number of clusters. Passing a range of minimum cluster sizes causes the algorithm to print to the terminal window the number of identified clusters with that value without displaying the embedding. This allows users to identify stable clustering solutions before plotting the clustering results. Typing ".save" after the optimal `min_cluster_size` to causes the program to save the current cluster IDs as anew column in the dataframe and return the data.

10. `getClustermap`: Computes a hierarchically-clustered heatmap of mean immunomarker intensity for clusters identified by the `clustering` module (module 9 above). This module is automated. Closing the clustermap window causes the clustermap to be saved to `<cylinter_output_dir>` and the program to proceed to the next module.

11. `lassoClusters`: In this module, cells of interest in the 2D tSNE or UMAP embedding are lassoed using a computer mouse or track pad. The three most-highly expressed immunomarkers for the selected cells are then determined and printed to terminal window. This module does not filter data, but may helpful in identifying cell subsets not captured by the current clustering solution.

12. `frequencyStats`: Compute pairwise statistics for each set of binary declarations specified as the third elements of the `sample_metadata` configuration parameter. This module is automated and configurable; see `<cylinter_input_dir>/config.yml` for parameters and their descriptions. Results of statistical tests are saved to `<cylinter_output_dir>/frequency_stats`.

13. `setContrast`: This module allows users to adjust image contrast settings. Settings are applied to image galleries curated by the `curateThumbnails` module (module 14 below). Users can toggle immunomarker channels on and off by clicking on their respectively labeled buttons at the left-hand side of the Napari image viewer. The contrast limit slider in the upper-left corner of the viewer is used to increase image gain and threshold background signal intensities. Once contrast settings have been adjusted for all immunomarkers, the Napari viewer is closed to proceed to the next module. Removal of `<cylinter_output_dir>/contrast_limits.yml` is required to re-assign image contrast settings.

14. `curateThumbnails`: Create image galleries of examples of cells drawn at random from each cluster identified by the `clustering` module (module 9 above). This module is automated but configurable; see `<cylinter_input_dir>/config.yml` for parameters and their descriptions. Image contrast settings assigned by `setContrast` module are applied to increase clarity of discrete cell states. Image galleries for each cluster are saved to `<cylinter_output_dir>/thumbnails`. Clusters determined to be based on residual dataset noise (and not biology) maybe dropped from the dataframe returned by this module and re-analyzed by re-running modules 9-14.

* Parquet files of redacted single-cell data returned by each module are saved to the `checkpoints` directory for use in discovery-driven analyses.

# Program execution

CyLinter presents users with a series of graphical-user-interface (GUI) windows for image inspection, parameter selection, and data visualization to allow for the identification and removal of cell segmentation instances corrupted by microscopy artifacts. The workflow begins with users populating the template configuration file (`<cylinter_input_path>/config.yml`) with experimental metadata. The file is annotated with descriptions of usage for each parameter. Once the configuration file has been updated, activate the CyLinter virtual environment and run the program:  

``` bash
# Activate virtual environment
source ~/cylinter/bin/activate

# To run the pipeline beginning from the first module:
cylinter <cylinter_input_dir>/config.yml

# ALternvatively, passing the `--module` flag allows users to pick up where they left off and within and between modules:
cylinter --module <module_name> <cylinter_input_dir>/config.yml
```

# Module usage
A combined dataframe of single-cell data from all samples is redacted based on ROI selection and various QC cutoffs while being passed between a series of QC modules (described below). Partially-redacted single-cell data are saved as `.parquet` files to the `cylinter_output_path/checkpoints` directory after each module to allow for dynamic restarts when a specific start module is passed using the `--module` flag.

1. `getSingleCellData`: Combines single-cell data from all samples (whole tissue sections or TMA cores) into one dataframe which is passed between modules. This stage of the program is automated.

2. `selectROIs`: ROIs are selected using positive or negative selection by toggling the `delint_mode` parameter in the CyLinter configuration file. Using the polygon selection tools built into the Napari image viewer (triangle, square, and circle icons), users use a computer mouse or trackpad to draw boundaries around cells devoid of optical artifacts to be carry forward into downstream analysis (positive selection). Alternatively, for relatively clean datasets, negative ROI selection may be used to drop cells affected by optical artifacts from the analysis. Closing the Napari window causes the program to advance to the next tissue in need of ROI selection until ROIs have been curated for all tissues in a given analysis. If a Napari window is closed without drawing ROIs, all cells for that tissue are carried forward in the analysis. Vertices defining the coordinates of each polygon are stored as key:value pairs in `<cylinter_output_path>/ROIs`. Removal of `<cylinter_output_path>/ROI/polygon_dict.pkl` (or removal of specific key:value pairs) is required to re-define ROIs.

3. `dnaIntensityCutoff`: Out-of-focus and mis-segmented cells can have low nuclear counterstain intensity. Conversely, counterstain oversaturation and tissue folding can cause cell over-segmentation. In this module, histograms of mean nuclear counterstain intensity (e.g. Hoechst, DAPI) are visualized using interactive Matplotlib widgets. Sliders for upper and lower cutoff assignment are clicked then dragged into desired positions on the histogram using a computer mouse or trackpad. Data falling between the upper and lower cutoffs can optionally be visualized as scatter points superimposed on counterstained cells from the current sample to check for fit by entering the name of the current sample into the text box at the bottom of the widget and clicking return. A Napari image viewer will then open. Sliders can then be re-adjusted and checked for fit. Closing the Napari window or the histogram widget saves the current thresholds and causes the program to advance to the next tissue in need of cutoff selection until cutoffs have been curated for all tissues in a given analysis.

4. `dnaAreaCutoff`: Functionality of this module is similar to `dnaIntensityCutoff` except cell segmentation area (pixel counts) are plotted. Lower cutoffs can remove over-segmented nuclei. Upper cutoffs can remove under-segmented cells.

5. `crossCycleCorrelation` (optional, for multi-cycle experiments): When cell segmentation is performed on counterstained cells from the first imaging cycle (as is commonly done), cells that moved or became detached from the microscope slide over the course of multi-cycle imaging will result in false-negative signals in all immunomarker channels subsequent to the drop-out event. This module allows users to visualize histograms of log<sub>10</sub>(cycle<sub>1</sub>/cycle<sub>n</sub>) using interactive Matplotlib widgets. Correlated counterstain signal intensities between the first and last imaging cycles result in values around 0.0 and are indicative of cells that had remained stable over the course of imaging. Thresholds in this module can be can be applied to histogram bins (x-axis gating) or histogram counts (y-axis gating) (see `cutoffAxis` parameter in the CyLinter configuration file). In Y-axis thresholding, a single cutoff is applied to all samples. This approach is more efficient than per sample x-axis gating and works well for experiments with relatively little tissue loss. On the other hand, X-axis thresholding is preferred for samples exhibiting substantial tissue loss, as a single histogram counts cutoff will include uncorrelated data points.

6. `log10transform`: Log-transform immunomarker data. This module is automated.

7. `pruneOutliers`: Channel outliers that can significantly influence the range of natural protein distributions. This module allows users to remove immunomarker signal intensity outliers by assigning upper and lower percentile cutoffs on immunomarker signal intensities. Distributions are either visualized as scatter plots or hexbins of immunomarker signal vs. nuclear area. Hexbins are recommended to reduce plot rendering time of large datasets (see `hexbins` parameter in CyLinter configuration file). Users select cutoffs by entering lower and upper percentile cutoff values between 0.0 and 100.0 into the text box pop-up window. Plots are re-rendered with outliers removed for for confirmation or refinement. Closing the text box window will cause the current cutoff settings to be saved and the program to proceed to the next channel. Closing the text box without entering cutoffs will cause the data to be rescaled between 0 and 1 with no outlier removal. Cutoff values are stored as a Python dictionary of key:value pairs in `<cylinter_output_path>/pruning/pruning_dict.pkl`. Once cutoffs for all channels have been assigned, the program loops through the cutoff dictionary to drop cells from the dataframe in the same order in which they were curated. `pruning_dict.pkl` must be removed to re-define percentile cutoffs. Removing specific key:value pairs is not recommended, as percentile cutoffs are applied in a non-commutative ordered series.

8. `metaQC` (optional): The metaQC module allows users to compensate for potential mis-classification of data as either "clean" or "noisy" based on data cutoff assignments. The module performs density-based clustering (HDBSCAN) on either TSNE or UMAP embeddings (see `config.yml`) of single-cell data class-balanced with clean and noisy data as previously determined by cutoff assignments. Once an optimal clustering has been identified through interactive parameter selection and data visualization, the algorithm assigns all points falling within each cluster as either "clean" or "noisy", regardless of whether a cluster is comprised of cells representing both quality categories based on a cutoff on the fraction of clean data in the cluster. The single-cell dataframe is then automatically updated to reflect the data type re-classification. This module can be skipped by specifying `metaQC: False` in `config.yml`.

9. `PCA`: Perform principle components analysis (PCA) on sample mean immunomarker signal intensities. This module is automated and configurable (see `config.yml`).

10. `clustering`: Performs hierarchical, density-based clustering (HDBSCAN) on either tSNE or UMAP embeddings (see `config.yml`) of cleaned single-cell data. After embedding, users enter into a text box a `min_cluster_size` (or range of such values) for performing HDBSCAN clustering. This parameter has a significant effect on the clustering result, with lower values generally leading to more clusters. Other clustering parameters can be changed by editing the source code for this module directly in `components.py` that are not specified in the experiment configuration file (`config.yml`). Passing a range of minimum cluster sizes causes the algorithm to display within the terminal window the number of clusters identified with each `min_cluster_size` integer to allow users to evaluate several clustering solutions, which can be visualized by re-entering a `min_cluster_size` value of interest. Cluster IDs for the current clustering can be applied to the cleaned dataframe by typing ".save" after the optimal `min_cluster_size` value in the text box and clicking return.

11. `getClustermap`: Computes a heatmap (hierarchically-clustered) of mean immunomarker signal intensities for each cluster identified by the `clustering` module. The heatmap is presented to the user after it is computed for review. Closing the heatmap preview window causes the heatmap to be saved in `<cylinter_output_path/clustering/final/>` and the program to proceed to the next module.

12. `lassoClusters`: Cells of interest in the 2D tSNE or UMAP embeddings may be selected to evaluate the top three most abundant proteins expressed by the group using a Matplotlib widget for lasso-based data selection using a computer mouse or track pad which are printed to the terminal window. This module does not perform data filtration, but may helpful in characterizing cell populations that failed to be identified as a discrete cluster by the HDBSCAN algorithm used in the `clustering` module (above).

13. `frequencyStats`: Computes pairwise statistics for binary declarations specified as the third elements of the `sample_metadata` dictionary (see `config.yml`). This module is automated and configurable. Results of statistical tests are saved to `<cylinter_output_path>/clustering/final/frequency_stats/`.

14. `setContrast`: Use the Napari image viewer to adjust image contrast settings on a given multi-channel image `config.yml`. Settings are applied to images curated by the `curateThumbnails` module (below). Users toggle channels on and off by clicking on respectively-labeled buttons at the left of the Napari viewer. The "contrast limit" slider is used to increase image gain (upper slider) and to threshold background signal intensities (lower slider). Closing the viewer applies the latest contrast settings to all images in the analysis and the program to proceed to the next module. Remove `<cylinter_output_path>/contrast_limits.yml` and re-run this module to re-define image contrast settings.

15. `curateThumbnails`: Generate image galleries of examples cells drawn randomly from clusters identified by the `clustering` module (above). This module is automated, but configurable (see `config.yml`). Image contrast settings assigned by the `setContrast` module are applied to increase signal-to-noise in the vetting of clusters as bona fide discrete cell-states. Cluster image galleries are saved to `<cylinter_output_path>/clustering/final/thumbnails`.

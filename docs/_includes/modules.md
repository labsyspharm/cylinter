# Module Descriptions

1. `aggregateData`: This module aggregates single-cell data from all tissues into a single dataframe for redaction by downstream modules; this module is fully automated.

2. `selectROIs`: In this module, polygon selection tools built into the Napari image viewer (i.e. triangle, circle, and square icons) are used to gate on tissue regions of interest (ROIs). Positive and negative selection modes are available (see `delintMode` parameter in `config.yml`). In positive selection, cells within ROI boundaries are carried forward into downstream analysis. In negative selection, selected cells are dropped from analysis. Negative selection is preferred when datasets exhibit diffuse artifacts. Closing the Napari window after drawing ROIs for a given tissue causes the program to advance to the next tissue for ROI selection. Closing the window without drawing an ROI causes all cells to be selected for that tissue. ROI polygon vertices are stored as key:value pairs in `<cylinter_output_path>/ROI/polygon_dict.pkl`. This file must be removed (or individual key:value pairs must be deleted) to re-define ROIs.

3. `intensityFilter`: Out-of-focus and mis-segmented cells tend to have lower nuclear counterstain signal intensities (e.g. Hoechst, DAPI) relative to in-focus, accurately segmented cells. Conversely, excessively bright DNA signals may indicate counterstain oversaturation or regions of tissue folding which can decrease segmentation accuracy. In this module, histograms of mean nuclear counterstain signal intensity are visualized as interactive plots with sliders for upper and lower intensity cutoffs. After adjusting the sliders, users can visualize selected cells between lower and upper cutoffs for a given tissue by entering the name of the target tissue into the provided text box at the bottom of the interactive histogram plot. A Napari window will open showing the DNA image (first imaging cycle in multi-cycle experiments) together with scatter points at the selected cell centroids that will be carried forward into downstream analysis. Scatter points are colored according to DNA signal intensities of selected cells. Segmentation outlines are provided as a fiducial reference for evaluating proper cutoff assignments. Closing the histogram window causes the program to apply the current cutoffs and proceed to the next tissue for cutoff selection. Closing the histogram window without adjusting sliders selects all cells from that tissue.

4. `areaFilter`: Cell segmentation errors introduce significant error into image-derived single-cell data. In this module, users assign lower and upper cutoffs on cell segmentation area (calculated as total pixel number for each cell segmentation instance by [MCMICRO](https://mcmicro.org/) to remove under- and over-segmented cells using a similar procedure to that used in the `intensityFilter` module.

5. `cycleCorrelation`: This module pertains to cyclic imaging technologies (e.g. t-CyCIF) and is designed to remove cells that have moved or become detached from the microscope slide over the course of imaging. This phenomenon, referred to as cell dropout, leads to false-negative signal intensities for all immunomarkers used after the cell dropout event. To remove cell dropout, users apply lower and upper cutoffs on the log<sub>10</sub>-transformed ratio of nuclear counterstain signals between cells at the first and last imaging cycles (log<sub>10</sub>(cycle<sub>1</sub>/cycle<sub>n</sub>) for a given tissue. Users adjust sliders to select cells with highly correlated signals that are centered around zero (as log<sub>10</sub>(x/x) = 0). After gate placement, users can visualize where selected cells reside in a given tissue by entering the name of the target tissue into the provided provided text box at the bottom of the interactive histogram plot. A Napari window then opens showing DNA channels for the first and last imaging cycles together with scatter points at the nuclear centroids of selected cells which will be carried forward into downstream analysis. Tissues exhibiting little tissue loss may be gated by applying a single Y-axis cutoff on cell counts. In this method, users first visualize histograms for all tissues in the analysis, then enter a single cutoff into the provided text box. Histograms will be re-rendered with a horizontal line at the assigned cutoff for confirmation or refinement. Y-axis gating may be toggled using the `cutoffAxis` parameter in `config.yml`. Although y-axis gating expedites the gating procedure, it may be unsuitable for tissues exhibiting large amounts of tissue loss.

6. `logTransform`: This module performs log<sub>10</sub>-transformation on raw immunomarker signal intensities and is fully automated.

7. `pruneOutliers`: Cells affected by antibody aggregates and spurious optical artifacts can appear as outliers in the affected channel(s) and negatively impact the results of unsupervised cell clustering. In this module, users crop extreme outliers from each tissue by applying lower and upper percentile cutoffs on immunomarker signals for a given channel. Scatter plots (or alternatively hexbins) of channel signal intensity versus cell segmentation area are visualized before entering a pair of lower and upper percentile cutoffs formatted as floating points into the provided text box (`lower_cutoff, upper_cutoff`, range: 0.0-100.0). Plots are re-rendered with outliers removed for confirmation or refinement. Hexbins are recommended for larger datasets to reduce plot rendering times and can be toggling using the `hexbins` parameter in `config.yml`. Closing the text box window causes the current cutoff settings to be applied and the program to proceed to the next channel for cutoff assignment. Closing the text box window without entering cutoffs causes all cells to be selected for that channel. Once cutoff assignments have been made for all channels, the program applies the cutoffs to the data in the order in which they were curated, then re-scales the remaining channel signal intensities between 0 and 1. Percentile cutoffs are stored as key:value pairs in `<cylinter_output_path>/pruning/pruning_dict.pkl`. Remove `pruning_dict.pkl` to re-define cutoffs.

8. `metaQC` (optional): The metaQC module is designed to correct for data mis-classification that may have occurred due to gating inaccuracies in prior modules. This module combines clean and noisy data and performs density-based, unsupervised clustering via [HDBSCAN](https://hdbscan.readthedocs.io/en/latest/api.html) on data points. Users are presented with an interactive plot showing either a tSNE or UMAP embedding (see `config.yml`) colored by HDBSCAN cluster at left, QC status and reclassification status at the center, and sample name at right. A text box located above the HDBSCAN plot is provided to allow users to change the minimum cluster size (`min_cluster_size`, formatted as an integer value), which automatically re-renders the HDBSCAN plot with the updated cluster labels. To aid in identifying a stable clustering solution, a range of hyphen-delimited `min_cluster_size` values may also be entered into the text box (#-#). This causes the program to loop over values within the specified range and print to the terminal window the number of clusters associated with each value without updating the HDBSCAN plot. Cells in the HDBSCAN plot can also be selected using a lasso tool by clicking and holding the mouse button followed by closing the interactive plot window. This causes a Napari window to come up showing the selected cells colored by the stage at which they were filtered from the analysis in the tissue specified in the previous plot. Using the `reclassCutoff` parameter in `config.yml`, users specify tolerance limits on the proportion of clusters composed of clean and noisy data for cells identified clusters; ambiguous (or unclustered) cells always maintain their original QC status annotations. Typing ".save" after a `min_cluster_size` causes the program to reclassify data according to the current clustering solution and reclassification cutoffs. Data reclassification can be bypassed by toggling the `metaQC` parameter in `config.yml`. In either case, a pie chart showing the fraction of data redacted by each of the prior QC modules is saved to `<cylinter_output_path/clustering/censored_by_stage.pdf>`

9. `PCA`: This module performs principle component analysis (PCA) on mean immunomarker signal intensities for a given set of tissues (see `config.yml` for details). A PCA scores plot is saved to `<cylinter_output_path/PCA/pcaScoresPlot.pdf>`.

10. `clustering`: This module performs density-based, hierarchical clustering (HDBSCAN) on tSNE or UMAP embeddings of cleaned data using an approach similar to that described in the `metaQC` module. Typing ".save" after an optimal `min_cluster_size` causes the program to append the current cluster IDs to the redacted dataframe and proceed to the next module.

11. `clustermap`: This module computes a hierarchically-clustered heatmap of mean immunomarker signal intensities for clusters identified in the `clustering` module. The same heatmap is plotted with signal normalization applied across channels and across clusters. Closing the heatmap preview windows causes the figures to be saved in `<cylinter_output_path/clustering/final>` and the program to proceed to the next module.

12. `setContrast`: In this module, the Napari image viewer is used to adjust image contrast settings on a reference tissue which is specified by the `viewSample` parameter in `config.yml`. Contrast settings are then applied to all other tissues in the analysis before images are curated by the `curatethumbnails` module. Users toggle channels on and off by clicking on their respectively labeled buttons at the left side of the Napari window and moving the lower and upper sliders on the "contrast limits" control bar in the upper-left of the Napari window. The lower slider thresholds background signal intensities, while the upper slider increases channel gain. Closing the Napari viewer stores the current settings as key:value pairs in `<cylinter_output_path>/contrast/contrast_limits.yml` and causes the program to proceed to the next module. Remove the `contrast_limits.yml` file (or edit specific key:value pairs) to re-define image contrast settings.

13. `curateThumbnails`: This module programmatically generates image galleries of cells drawn at random from each cluster identified in the `clustering` module. Image contrast settings defined in the `setContrast` module are applied to images prior to thumbnail curation. A single white pixel corresponding to the nuclear centroid of the reference cell is shown in each image as a fiducial reference for the reference cell. Optionally, images can be saved with segmentation outlines superimposed by toggling the `segOutlines` parameter in `config.yml`. The number and size of thumbnail examples can also be specified using the `numThumbnails` and `squareWindowDimension` parameters in `config.yml`. Image galleries per cluster are saved in `<cylinter_output_path>/clustering/final/thumbnails/`.

14. `frequencyStats`: The module computes pairwise statistics for binary declarations specified in the `sampleMetadata` dictionary in `config.yml` (fourth elements). Test results are saved in `<cylinter_output_path>/clustering/final/frequency_stats`. This module is automated and configurable; see `config.yml` for details.

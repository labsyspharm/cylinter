# Module Descriptions

1. `aggregateData`: This module aggregates single-cell data from all tissues into a single dataframe for redaction by downstream modules; this module is fully automated.

2. `selectROIs`: In this module, polygon selection tools built into the Napari image viewer (i.e. triangle, circle, and square icons) are used to gate on tissue regions of interest (ROIs). Positive and negative selection modes are available (see `delintMode` parameter in `config.yml`). In positive selection, cells within ROI boundaries are carried forward into downstream analysis. In negative selection, selected cells are dropped from the analysis. Negative selection is preferred when datasets exhibit diffuse artifacts. Closing the Napari window after drawing ROIs for a given tissue causes the program to advance to the next tissue for ROI selection. Closing the window without drawing an ROI causes all cells to be selected for that tissue. ROI polygon vertices are stored as key:value pairs in `<cylinter_output_path>/ROI/polygon_dict.pkl`. This file must be removed (or individual key:value pairs must be deleted) in order to re-define ROIs.

3. `intensityFilter`: Out-of-focus and mis-segmented cells tend to have lower nuclear counterstain signal intensities (e.g. Hoechst, DAPI) relative to in-focus and accurately segmented cells. Conversely, excessively bright nuclear signals may indicate counterstain oversaturation or regions of tissue folding, which suffer from poor segmentation performance. In this module, histograms of mean nuclear counterstain signal intensity are visualized as interactive plots with sliders for upper and lower intensity cutoffs. After adjusting the sliders, users can visualize selected cells (between lower and upper sliders) within a given tissue of interest by entering the name of the target tissue into the provided provided text box at the bottom of the plot. A Napari window will then open showing the DNA channel (first imaging cycle if data are from a multi-cycle experiment) with scatter points at the selected cell centroids which will be carried forward into downstream analysis. Scatter points are colored according to signal intensities of selected cells. Segmentation outlines are provided as a fiducial reference. Closing the histogram window (or its associated Napari windows) causes the program to apply the current cutoffs and proceed to the next tissue for cutoff selection. Closing the histogram window without adjusting sliders is equivalent to selecting all cells from that tissue.

4. `areaFilter`: Cell segmentation errors introduce significant error into single-cell feature tables. In this module, users assign lower and upper cutoffs on cell segmentation area (calculated as the total pixel number for each segmentation instance by [MCMICRO](https://mcmicro.org/) to remove under- and over-segmented cells using a similar method that used in the `intensityFilter` module.

5. `cycleCorrelation`: This module is pertinent to multi-cycle imaging platforms only and is designed to remove cells from the analysis which have became detached from the microscope slide over the course of imaging. This phenomenon, referred to as cell-dropout, causes false-negative signal intensities for immunomarkers probed for subsequent to the cell-dropout event. To remove cell-dropout, users apply lower and upper cutoffs on the log<sub>10</sub>-transformed ratio of nuclear counterstain signals between cells at the first and last imaging cycles (log<sub>10</sub>(cycle<sub>1</sub>/cycle<sub>n</sub>) for a given tissue. Users adjust sliders to select cells with highly-correlated signals centered around zero (as log<sub>10</sub>(x/x) = 0). After gate placement, users can visualize where the selected cells reside in a given tissue by entering the name of the target tissue into the provided provided text box at the bottom of the interactive plot. A Napari window will then open showing the nuclear counterstain channels for the first and last imaging cycles together with scatter points at the nuclear centroids of the cells which will be carried forward into downstream analysis based on current cutoffs. Tissues exhibiting little tissue loss may be gated using a single cutoff applied to histogram y-axes (counts). In this method, users first visualize histograms for all tissues in the analysis, then enter a single cutoff into the provided text box. The histograms will be re-rendered with a horizontal line at the assigned cutoff for confirmation or refinement. Y-axis gating may be toggled using the `cutoffAxis` parameter in `config.yml`. Although y-axis gating expedites the gating procedure, it may be unsuitable for tissues exhibiting large amounts of tissue loss.

6. `log10transform`: This module performs log<sub>10</sub>-transformation on raw immunomarker signal intensities and is fully automated.

7. `pruneOutliers`: Cells affected by antibody aggregates and spurious optical artifacts can appear as outliers in the affected channel(s) which negatively impacts the results of unsupervised cell clustering. In this module, users crop extreme outliers from each tissue by applying lower and upper percentile cutoffs on immunomarker signal intensities. Scatter plots (or alternatively hexbins) of channel signal intensity versus cell segmentation area are visualized before entering a comma-delimited pair of lower and upper percentile cutoffs into the provided text box (range: 0.0-100.0). Plots are re-rendered with outliers removed for confirmation or refinement. Hexbins are recommended for larger datasets to reduce plot rendering times and can be toggling the `hexbins` parameter in `config.yml`. Closing the text box window causes the current cutoff settings to be applied and the program to proceed to the next channel for cutoff assignment. Closing the text box window without entering cutoffs causes all cells to be selected for that channel. Once cutoff assignments have been made for all channels, the program applies the cutoffs to the data in the same order in which they were curated and re-scales channel signal intensities between 0 and 1. Percentile cutoffs are stored as key:value pairs in `<cylinter_output_path>/pruning/pruning_dict.pkl`. Remove `pruning_dict.pkl` to re-define cutoffs.

8. `metaQC` (optional): The metaQC module is designed to correct for data mis-classification that may have occurred due to gating inaccuracies. This module combines clean and noisy data and performs density-based, unsupervised clustering by [HDBSCAN](https://hdbscan.readthedocs.io/en/latest/api.html) on them. Users are presented with an interactive plot showing the tSNE or UMAP embedding (see `config.yml`) colored by HDBSCAN cluster at left, QC status and reclassification status at the center, and sample name at right. A text box located above the HDBSCAN plot is provided to allow users to change the minimum cluster size (`min_cluster_size`, integer values), which automatically re-renders the HDBSCAN plot with the updated cluster labels. To aid in identifying a stable clustering solution, a range of hyphen-delimited `min_cluster_size` values may also be entered into the text box (#-#). This causes the program to loop over values within the range and print to the terminal window the number of clusters associated with each value without updating the HDBSCAN plot. Cells in the HDBSCAN plot can also be selected using a lasso tool by clicking and holding the mouse button, then closing the interactive plot. A Napari window will then come up showing the selected cells (colored by the stage at which they were filtered from the analysis) in the selected tissue. Using the `reclassCutoff` parameter in `config.yml`, users will have specified a tolerance limits on the proportion of clusters composed of clean and noisy data for all cells in that cluster to be considered data of a certain type; ambiguous (or unclustered) cells maintain their original annotations. Typing ".save" after a `min_cluster_size` causes the program to reclassify data according to the current clustering solution and reclassification cutoffs. Experienced users may also wish to adjust additional clustering parameters which can be achieved by editing the source code for this module in `/Users/<user>/cylinter/lib/python3.8/site-packages/cylinter/components.py`. Data reclassification can be bypassed by toggling the `metaQC` parameter in `config.yml`.

9. `PCA`: This module performs principle component analysis (PCA) on mean immunomarker signal intensities for sets of tissues (see `config.yml` for details). A PCA scores plot is saved to `<cylinter_output_path/PCA/pcaScoresPlot.pdf>`.

10. `clustering`: This module performs density-based, hierarchical clustering (HDBSCAN) on tSNE or UMAP embeddings of data from the redacted dataframe using an approach similar to that described in the `metaQC` module. Typing ".save" after an optimal `min_cluster_size` causes the program to append the current cluster IDs to the redacted dataframe and proceed to the next module.

11. `clustermap`: This module computes a hierarchically-clustered heatmap of mean immunomarker signal intensities for clusters identified in the `clustering` module . Closing the heatmap preview window causes the figure to be saved in `<cylinter_output_path/clustering/final/clustermap.pdf>` and the program to proceed to the next module.

12. `setContrast`: In this module, the Napari image viewer is used to adjust image contrast settings on a reference tissue specified by the `viewSample` parameter in `config.yml`. Settings are then applied to all tissues in the analysis and used to visualize cells in the `curatethumbnails` module. Users toggle channels on and off by clicking on their respectively labeled buttons at the left-hand side of the Napari window and moving the lower and upper sliders on the "contrast limits" control bar in the upper-left of the Napari window. The lower slider thresholds background signal intensities, while the upper slider increases channel gain. Closing the Napari viewer stores the current settings as key:value pairs in `<cylinter_output_path>/contrast/contrast_limits.yml` and causes the program to proceed to the next module. Remove the `contrast_limits.yml` file (order update specific key:value pairs) to re-define image contrast settings.

13. `curateThumbnails`: This module programmatically generates image galleries of cells drawn at random from each cluster identified in the `clustering` module. Image contrast settings defined in the `setContrast` module are applied to images prior to thumbnail curation. A single white pixel corresponding to the nuclear centroid of the reference cell is shown in each image as a fiducial reference for the reference cell. Optionally, images can be saved with segmentation outlines superimposed by toggling the `segOutlines` parameter in `config.yml`. The number and size of thumbnail examples can also be specified using the `numThumbnails` and `squareWindowDimension` parameters in `config.yml`. Image galleries per cluster are saved in `<cylinter_output_path>/clustering/final/thumbnails/`.

14. `frequencyStats`: Computes pairwise statistics for binary declarations specified in the `sampleMetadata` dictionary in `config.yml` (fourth elements). Statistical results are saved in `<cylinter_output_path>/clustering/final/frequency_stats/`. This module is automated and configurable; see `config.yml` for details.
